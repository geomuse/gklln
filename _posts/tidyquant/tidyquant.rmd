---
title: "r stduo tidyquant"
author : geo
output: html_document
---

tidyquant
```{r}
install.packages('tidyquant')
```

```{r}
library(tidyquant)
library(dplyr)
# ä¸‹è½½å¤šæ”¯è‚¡ç¥¨
stocks <- tq_get(c("AAPL", "MSFT", "GOOG"),
                 from = "2020-01-01",
                 to   = "2024-12-31")

head(stocks)
```

```{r}
aapl <- tq_get("AAPL",
                 from = "2020-01-01",
                 to   = "2024-12-31")

head(aapl)
```

```{r}
returns <- aapl %>%
  tq_transmute(select     = adjusted,     # é€‰æ‹©è°ƒæ•´æ”¶ç›˜ä»·
               mutate_fun = periodReturn, # è®¡ç®—æ”¶ç›Šç‡
               period     = "daily",      # æ—¥æ”¶ç›Šç‡
               type       = "log")        # å¯¹æ•°æ”¶ç›Šç‡

head(returns)
```

```{r}
multi_returns <- stocks %>%
  group_by(symbol) %>%
  tq_transmute(select     = adjusted,
               mutate_fun = periodReturn,
               period     = "monthly",
               type       = "log")

head(multi_returns)
```

```{r}
library(ggplot2)

multi_returns %>%
  ggplot(aes(x = date, y = monthly.returns, color = symbol)) +
  geom_line() +
  labs(title = "Monthly Returns",
       y = "Log Returns")
```

```{r}
aapl_fin <- tq_get("AAPL", get = "financials")
aapl_fin
```

```{r}
# å®‰è£…å¿…è¦å¥—ä»¶
if(!require(tidyquant)) install.packages("tidyquant")
if(!require(dplyr)) install.packages("dplyr")
if(!require(ggplot2)) install.packages("ggplot2")

library(tidyquant)
library(dplyr)
library(ggplot2)

# Step 1: å®šä¹‰è‚¡ç¥¨æ± 
stock_pool <- c("AAPL", "MSFT", "GOOG", "AMZN", "TSLA",
                "META", "NFLX", "NVDA", "ORCL", "INTC")

# Step 2: ä¸‹è½½è¿‡å» 2 å¹´çš„è‚¡ä»·
stocks <- tq_get(stock_pool,
                 from = "2023-01-01",
                 to   = Sys.Date())

# Step 3: è®¡ç®—æ¯æœˆæ”¶ç›Šç‡
monthly_returns <- stocks %>%
  group_by(symbol) %>%
  tq_transmute(select     = adjusted,
               mutate_fun = periodReturn,
               period     = "monthly",
               type       = "log")

# Step 4: è®¡ç®—æ¯æ”¯è‚¡ç¥¨çš„ç´¯è®¡æ”¶ç›Šç‡
cumulative_returns <- monthly_returns %>%
  group_by(symbol) %>%
  summarise(total_return = sum(monthly.returns, na.rm = TRUE)) %>%
  arrange(desc(total_return))

# å–å‰ 5 åè‚¡ç¥¨
top5 <- head(cumulative_returns, 5)
print(top5)

# Step 5: ç»˜åˆ¶å‰ 5 åè‚¡ç¥¨çš„æ”¶ç›Šèµ°åŠ¿
monthly_returns %>%
  filter(symbol %in% top5$symbol) %>%
  ggplot(aes(x = date, y = monthly.returns, color = symbol)) +
  geom_line(size = 1) +
  labs(title = "å‰5åé«˜æ”¶ç›Šè‚¡ç¥¨æœˆåº¦æ”¶ç›Šèµ°åŠ¿",
       x = "æ—¥æœŸ",
       y = "æœˆåº¦å¯¹æ•°æ”¶ç›Šç‡") +
  theme_minimal()

```

```{r}
# å®‰è£…å¥—ä»¶
if(!require(shiny)) install.packages("shiny")
if(!require(tidyquant)) install.packages("tidyquant")
if(!require(dplyr)) install.packages("dplyr")
if(!require(ggplot2)) install.packages("ggplot2")
if(!require(DT)) install.packages("DT")

library(shiny)
library(tidyquant)
library(dplyr)
library(ggplot2)
library(DT)

# ---------------------
# UI
# ---------------------
ui <- fluidPage(
  titlePanel("ğŸ“ˆ é€‰è‚¡æœºå™¨äºº (Shiny + tidyquant)"),
  
  sidebarLayout(
    sidebarPanel(
      textInput("symbols", "è¾“å…¥è‚¡ç¥¨æ±  (ç”¨é€—å·åˆ†éš”):",
                value = "AAPL,MSFT,GOOG,AMZN,TSLA,META,NFLX,NVDA,ORCL,INTC"),
      
      dateRangeInput("daterange", "é€‰æ‹©æ—¥æœŸèŒƒå›´:",
                     start = "2023-01-01", end = Sys.Date()),
      
      actionButton("run", "å¼€å§‹é€‰è‚¡", class = "btn-primary")
    ),
    
    mainPanel(
      h4("å‰ 5 åé«˜æ”¶ç›Šè‚¡ç¥¨"),
      DTOutput("table"),
      h4("æ”¶ç›Šèµ°åŠ¿å›¾"),
      plotOutput("plot", height = "500px")
    )
  )
)

# ---------------------
# Server
# ---------------------
server <- function(input, output) {
  
  observeEvent(input$run, { # nolint
    req(input$symbols) # nolint
    
    # Step 1: å¤„ç†è‚¡ç¥¨æ± è¾“å…¥
    stock_list <- strsplit(input$symbols, ",")[[1]] %>% trimws()
    
    # Step 2: ä¸‹è½½è‚¡ä»·æ•°æ®
    stocks <- tq_get(stock_list,
                     from = input$daterange[1],
                     to   = input$daterange[2])
    
    # Step 3: è®¡ç®—æœˆæ”¶ç›Šç‡
    monthly_returns <- stocks %>%
      group_by(symbol) %>%
      tq_transmute(select     = adjusted,
                   mutate_fun = periodReturn,
                   period     = "monthly",
                   type       = "log")
    
    # Step 4: è®¡ç®—ç´¯è®¡æ”¶ç›Š
    cumulative_returns <- monthly_returns %>%
      group_by(symbol) %>%
      summarise(total_return = sum(monthly.returns, na.rm = TRUE)) %>%
      arrange(desc(total_return))
    
    # Step 5: å–å‰ 5 å
    top5 <- head(cumulative_returns, 5)
    
    # è¾“å‡ºè¡¨æ ¼
    output$table <- renderDT({
      datatable(top5, options = list(pageLength = 5))
    })
    
    # è¾“å‡ºå›¾è¡¨
    output$plot <- renderPlot({
      monthly_returns %>%
        filter(symbol %in% top5$symbol) %>%
        ggplot(aes(x = date, y = monthly.returns, color = symbol)) +
        geom_line(size = 1) +
        labs(title = "å‰ 5 åé«˜æ”¶ç›Šè‚¡ç¥¨æœˆåº¦æ”¶ç›Šèµ°åŠ¿",
             x = "æ—¥æœŸ", y = "æœˆåº¦å¯¹æ•°æ”¶ç›Šç‡") +
        theme_minimal()
    })
    
  })
}

# ---------------------
# Run App
# ---------------------
shinyApp(ui = ui, server = server)

```