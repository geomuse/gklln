---
title: "r stduo tidyquant"
author : geo
output: html_document
---

tidyquant
```{r}
install.packages('tidyquant')
```

```{r}
library(tidyquant)
library(dplyr)
# ä¸‹è½½å¤šæ”¯è‚¡ç¥¨
stocks <- tq_get(c("AAPL", "MSFT", "GOOG"),
                 from = "2020-01-01",
                 to   = "2024-12-31")

head(stocks)
```

```{r}
aapl <- tq_get("AAPL",
                 from = "2020-01-01",
                 to   = "2024-12-31")

head(aapl)
```

```{r}
returns <- aapl %>%
  tq_transmute(select     = adjusted,     # é€‰æ‹©è°ƒæ•´æ”¶ç›˜ä»·
               mutate_fun = periodReturn, # è®¡ç®—æ”¶ç›Šç‡
               period     = "daily",      # æ—¥æ”¶ç›Šç‡
               type       = "log")        # å¯¹æ•°æ”¶ç›Šç‡

head(returns)
```

```{r}
multi_returns <- stocks %>%
  group_by(symbol) %>%
  tq_transmute(select     = adjusted,
               mutate_fun = periodReturn,
               period     = "monthly",
               type       = "log")

head(multi_returns)
```

```{r}
library(ggplot2)

multi_returns %>%
  ggplot(aes(x = date, y = monthly.returns, color = symbol)) +
  geom_line() +
  labs(title = "Monthly Returns",
       y = "Log Returns")
```

```{r}
aapl_fin <- tq_get("AAPL", get = "financials")
aapl_fin
```

```{r}
# å®‰è£…å¿…è¦å¥—ä»¶
if(!require(tidyquant)) install.packages("tidyquant")
if(!require(dplyr)) install.packages("dplyr")
if(!require(ggplot2)) install.packages("ggplot2")

library(tidyquant)
library(dplyr)
library(ggplot2)

# Step 1: å®šä¹‰è‚¡ç¥¨æ± 
stock_pool <- c("AAPL", "MSFT", "GOOG", "AMZN", "TSLA",
                "META", "NFLX", "NVDA", "ORCL", "INTC")

# Step 2: ä¸‹è½½è¿‡å» 2 å¹´çš„è‚¡ä»·
stocks <- tq_get(stock_pool,
                 from = "2023-01-01",
                 to   = Sys.Date())

# Step 3: è®¡ç®—æ¯æœˆæ”¶ç›Šç‡
monthly_returns <- stocks %>%
  group_by(symbol) %>%
  tq_transmute(select     = adjusted,
               mutate_fun = periodReturn,
               period     = "monthly",
               type       = "log")

# Step 4: è®¡ç®—æ¯æ”¯è‚¡ç¥¨çš„ç´¯è®¡æ”¶ç›Šç‡
cumulative_returns <- monthly_returns %>%
  group_by(symbol) %>%
  summarise(total_return = sum(monthly.returns, na.rm = TRUE)) %>%
  arrange(desc(total_return))

# å–å‰ 5 åè‚¡ç¥¨
top5 <- head(cumulative_returns, 5)
print(top5)

# Step 5: ç»˜åˆ¶å‰ 5 åè‚¡ç¥¨çš„æ”¶ç›Šèµ°åŠ¿
monthly_returns %>%
  filter(symbol %in% top5$symbol) %>%
  ggplot(aes(x = date, y = monthly.returns, color = symbol)) +
  geom_line(size = 1) +
  labs(title = "å‰5åé«˜æ”¶ç›Šè‚¡ç¥¨æœˆåº¦æ”¶ç›Šèµ°åŠ¿",
       x = "æ—¥æœŸ",
       y = "æœˆåº¦å¯¹æ•°æ”¶ç›Šç‡") +
  theme_minimal()

```

```{r}
library(quantmod)

# æŠ“è‚¡ä»·
getSymbols("AAPL", from = "2020-01-01")

# è´¢åŠ¡æ•°æ® (EPS, PE ç­‰)
aapl_pe <- getQuote("AAPL", what = yahooQF("P/E Ratio"))
print(aapl_pe)

library(tidyquant)
# æŠ“å– AAPL çš„è´¢åŠ¡æŠ¥è¡¨
aapl_fin <- tq_get("AAPL", get = "financials")

head(aapl_fin)
```

```{r}
library(quantmod)

# å®šä¹‰è¦æŠ“çš„åŸºæœ¬é¢å› å­
fundamentals <- yahooQF(c(
  "P/E Ratio",
  "Price/Book",
  "Price/Sales",
  "PEG Ratio",
  "Earnings/Share",
  "Dividend Yield",
  "Return on Equity",
  "Return on Assets",
  "Beta",
  "Total Debt/Equity",
  "Profit Margin",
  "Operating Margin"
))

# æŠ“å– AAPL çš„æ•°æ®
aapl_factors <- getQuote("AAPL", what = fundamentals)
print(aapl_factors)

```

```{r}
library(quantmod)
library(dplyr)

# 1. å®šä¹‰å¸¸è§åŸºæœ¬é¢å› å­
fundamentals <- yahooQF(c(
  "P/E Ratio",
  "Price/Book",
  "Price/Sales",
  "PEG Ratio",
  "Earnings/Share",
  "Dividend Yield",
  "Return on Equity",
  "Return on Assets",
  "Beta",
  "Total Debt/Equity",
  "Profit Margin",
  "Operating Margin"
))

# 2. å®šä¹‰å‡½æ•°ï¼šè¾“å…¥è‚¡ç¥¨ä»£ç å‘é‡ï¼Œè¿”å›åŸºæœ¬é¢å› å­è¡¨æ ¼
get_factors <- function(stocks) {
  results <- lapply(stocks, function(sym) {
    tryCatch({
      df <- getQuote(sym, what = fundamentals)
      df$Symbol <- sym
      return(df)
    }, error = function(e) {
      message(paste("Error fetching:", sym))
      return(NULL)
    })
  })
  
  # åˆå¹¶ç»“æœ
  result_df <- do.call(rbind, results)
  
  # æ•´ç†åˆ—é¡ºåº
  result_df <- result_df %>%
    relocate(Symbol, .before = 1)
  
  return(result_df)
}

# 3. æµ‹è¯•ï¼šä¸€æ¬¡æŠ“å–å¤šä¸ªè‚¡ç¥¨
stocks <- c("AAPL", "MSFT", "AMZN", "GOOG")
factor_table <- get_factors(stocks)

print(factor_table)

```

```{r}
# å®‰è£…å¹¶è½½å…¥å¥—ä»¶
install.packages("quantmod")
install.packages("dplyr")

library(quantmod)
library(dplyr)

# 1. è®¾å®šè‚¡ç¥¨æ± 
stocks <- c("AAPL", "MSFT", "AMZN", "GOOG")

# 2. å®šä¹‰è¦æŠ“çš„åŸºæœ¬é¢æŒ‡æ ‡
fundamentals <- yahooQF(c(
  "Price/Sales", 
  "P/E Ratio", 
  "Price/Book", 
  "Return on Equity"
))

# 3. æ‰¹é‡æŠ“å–æ•°æ®
data_list <- lapply(stocks, function(sym) {
  tryCatch({
    quote <- getQuote(sym, what = fundamentals)
    df <- data.frame(
      stock = sym,
      PriceToSales = as.numeric(quote[,"Price.Sales"]),
      PE = as.numeric(quote[,"P.E.Ratio"]),
      PB = as.numeric(quote[,"Price.Book"]),
      ROE = as.numeric(quote[,"Return.on.Equity"])
    )
    return(df)
  }, error = function(e) NULL)
})

# 4. åˆå¹¶ç»“æœ
df <- do.call(rbind, data_list)

# 5. æ„å»ºä¸€ä¸ªç®€å•å› å­ (ROE / PB) å¹¶æ’å
df <- df %>%
  mutate(ValueFactor = ROE / PB) %>%
  arrange(desc(ValueFactor))

print(df)
```

```{r}
# å®‰è£…å¥—ä»¶
install.packages(c("quantmod", "rvest", "dplyr", "stringr"))
library(quantmod)
library(rvest)
library(dplyr)
library(stringr)

# è‚¡ç¥¨æ± 
stocks <- c("AAPL", "MSFT", "AMZN", "GOOG")

# å®šä¹‰çˆ¬è™«å‡½æ•° (Yahoo Finance è´¢åŠ¡æ•°æ®)
get_fundamentals <- function(symbol) {
  url <- paste0("https://finance.yahoo.com/quote/", symbol, "/balance-sheet?p=", symbol)
  
  # è¯»å–ç½‘é¡µ
  page <- read_html(url)
  
  # çˆ¬å– balance sheet è¡¨æ ¼
  tbl <- page %>%
    html_nodes("div table") %>%
    .[[1]] %>%
    html_table(fill = TRUE)
  
  # æ•´ç†æˆ key-value å½¢å¼
  tbl <- tbl %>%
    setNames(c("Item", "Value")) %>%
    mutate(Value = str_replace_all(Value, ",", "")) %>%
    mutate(Value = as.numeric(Value))
  
  # æŠ“è‚¡ä¸œæƒç›Š (Total Stockholder Equity)
  equity <- tbl %>% filter(Item == "Total Stockholder Equity") %>% pull(Value)
  
  # å†çˆ¬ Income Statement æŠ“ Net Income
  url2 <- paste0("https://finance.yahoo.com/quote/", symbol, "/financials?p=", symbol)
  page2 <- read_html(url2)
  tbl2 <- page2 %>%
    html_nodes("div table") %>%
    .[[1]] %>%
    html_table(fill = TRUE)
  
  tbl2 <- tbl2 %>%
    setNames(c("Item", "Value")) %>%
    mutate(Value = str_replace_all(Value, ",", "")) %>%
    mutate(Value = as.numeric(Value))
  
  net_income <- tbl2 %>% filter(Item == "Net Income") %>% pull(Value)
  
  # ç”¨ quantmod æŠ“å½“å‰è‚¡ä»·
  price <- as.numeric(getQuote(symbol)$Last)
  
  # è®¡ç®—å› å­
  roe <- net_income / equity
  pe <- as.numeric(getQuote(symbol, what = yahooQF("P/E Ratio"))$"P.E.Ratio")
  pb <- as.numeric(getQuote(symbol, what = yahooQF("Price/Book"))$"Price.Book")
  
  return(data.frame(
    stock = symbol,
    Price = price,
    NetIncome = net_income,
    Equity = equity,
    ROE = roe,
    PE = pe,
    PB = pb,
    ValueFactor = roe / pb
  ))
}

# æ‰¹é‡æ‰§è¡Œ
results <- lapply(stocks, get_fundamentals)
df <- do.call(rbind, results)

# æŒ‰å› å­æ’åº
df_ranked <- df %>% arrange(desc(ValueFactor))

print(df)
print(df_ranked)
```

```{r}
# å®‰è£…å¥—ä»¶
if(!require(shiny)) install.packages("shiny")
if(!require(tidyquant)) install.packages("tidyquant")
if(!require(dplyr)) install.packages("dplyr")
if(!require(ggplot2)) install.packages("ggplot2")
if(!require(DT)) install.packages("DT")

library(shiny)
library(tidyquant)
library(dplyr)
library(ggplot2)
library(DT)

# ---------------------
# UI
# ---------------------
ui <- fluidPage(
  titlePanel("ğŸ“ˆ é€‰è‚¡æœºå™¨äºº (Shiny + tidyquant)"),
  
  sidebarLayout(
    sidebarPanel(
      textInput("symbols", "è¾“å…¥è‚¡ç¥¨æ±  (ç”¨é€—å·åˆ†éš”):",
                value = "AAPL,MSFT,GOOG,AMZN,TSLA,META,NFLX,NVDA,ORCL,INTC"),
      
      dateRangeInput("daterange", "é€‰æ‹©æ—¥æœŸèŒƒå›´:",
                     start = "2023-01-01", end = Sys.Date()),
      
      actionButton("run", "å¼€å§‹é€‰è‚¡", class = "btn-primary")
    ),
    
    mainPanel(
      h4("å‰ 5 åé«˜æ”¶ç›Šè‚¡ç¥¨"),
      DTOutput("table"),
      h4("æ”¶ç›Šèµ°åŠ¿å›¾"),
      plotOutput("plot", height = "500px")
    )
  )
)

# ---------------------
# Server
# ---------------------
server <- function(input, output) {
  
  observeEvent(input$run, { # nolint
    req(input$symbols) # nolint
    
    # Step 1: å¤„ç†è‚¡ç¥¨æ± è¾“å…¥
    stock_list <- strsplit(input$symbols, ",")[[1]] %>% trimws()
    
    # Step 2: ä¸‹è½½è‚¡ä»·æ•°æ®
    stocks <- tq_get(stock_list,
                     from = input$daterange[1],
                     to   = input$daterange[2])
    
    # Step 3: è®¡ç®—æœˆæ”¶ç›Šç‡
    monthly_returns <- stocks %>%
      group_by(symbol) %>%
      tq_transmute(select     = adjusted,
                   mutate_fun = periodReturn,
                   period     = "monthly",
                   type       = "log")
    
    # Step 4: è®¡ç®—ç´¯è®¡æ”¶ç›Š
    cumulative_returns <- monthly_returns %>%
      group_by(symbol) %>%
      summarise(total_return = sum(monthly.returns, na.rm = TRUE)) %>%
      arrange(desc(total_return))
    
    # Step 5: å–å‰ 5 å
    top5 <- head(cumulative_returns, 5)
    
    # è¾“å‡ºè¡¨æ ¼
    output$table <- renderDT({
      datatable(top5, options = list(pageLength = 5))
    })
    
    # è¾“å‡ºå›¾è¡¨
    output$plot <- renderPlot({
      monthly_returns %>%
        filter(symbol %in% top5$symbol) %>%
        ggplot(aes(x = date, y = monthly.returns, color = symbol)) +
        geom_line(size = 1) +
        labs(title = "å‰ 5 åé«˜æ”¶ç›Šè‚¡ç¥¨æœˆåº¦æ”¶ç›Šèµ°åŠ¿",
             x = "æ—¥æœŸ", y = "æœˆåº¦å¯¹æ•°æ”¶ç›Šç‡") +
        theme_minimal()
    })
    
  })
}

# ---------------------
# Run App
# ---------------------
shinyApp(ui = ui, server = server)

```