---
layout: post
title:  python flask Flask-Login
date:   2025-11-21 11:24:29 +0800
tags: 
    - python 
    - flask
image: 07.jpg
---

# 专案结构

```
flask_app/
│ app.py
│ config.py
│
├── models/
│     __init__.py
│     user.py
│
└── auth/
      __init__.py
      routes.py
      forms.py
```

# **安装 Flask-Login**

```bash
pip install flask-login
```

---

# **更新 User 模型（models/user.py）**

Flask-Login 需要 User 拥有几个属性：

* `is_authenticated`
* `is_active`
* `is_anonymous`
* `get_id()`

最简单方式是继承：

```python
from flask_login import UserMixin
from . import db

class User(db.Model, UserMixin):  # 加入 UserMixin
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(50), nullable=False)
    email = db.Column(db.String(120), unique=True, nullable=False)
    password = db.Column(db.String(200), nullable=False)  # 需要密码字段
```

> 如果你还没有 password 字段，需先做 migration。

---

# **创建 auth Blueprint**

### auth/**init**.py：

```python
from flask import Blueprint

auth_bp = Blueprint("auth", __name__, url_prefix="/auth")

from . import routes
```

---

# ** 创建登录表单（Flask-WTF）**

auth/forms.py：

```python
from flask_wtf import FlaskForm
from wtforms import StringField, PasswordField, SubmitField
from wtforms.validators import DataRequired, Email

class LoginForm(FlaskForm):
    email = StringField("Email", validators=[DataRequired(), Email()])
    password = PasswordField("Password", validators=[DataRequired()])
    submit = SubmitField("Login")
```

# **编写登录/登出逻辑（auth/routes.py）**

```python
from flask import render_template, redirect, url_for, flash, request
from werkzeug.security import check_password_hash
from flask_login import login_user, logout_user, login_required

from . import auth_bp
from .forms import LoginForm
from models.user import User
from models import db

@auth_bp.route("/login", methods=["GET", "POST"])
def login():
    form = LoginForm()

    if form.validate_on_submit():
        user = User.query.filter_by(email=form.email.data).first()

        if user and check_password_hash(user.password, form.password.data):
            login_user(user)
            flash("Login successful!", "success")
            return redirect(url_for("dashboard"))  # 登录后跳转的页面

        flash("Invalid email or password.", "danger")

    return render_template("login.html", form=form)


@auth_bp.route("/logout")
@login_required
def logout():
    logout_user()
    flash("Logged out.", "info")
    return redirect(url_for("auth.login"))
```

# **在 app.py 中初始化 Flask-Login**

app.py：

```python
from flask import Flask
from config import Config
from models import db
from models.user import User

from flask_migrate import Migrate
from flask_login import LoginManager

from auth import auth_bp

app = Flask(__name__)
app.config.from_object(Config)

# 初始化数据库
db.init_app(app)
migrate = Migrate(app, db)

# 初始化 Flask-Login
login_manager = LoginManager()
login_manager.login_view = "auth.login"  # 未登录自动跳转到 login
login_manager.init_app(app)

# 用户加载函数
@login_manager.user_loader
def load_user(user_id):
    return User.query.get(int(user_id))

# 注册蓝图
app.register_blueprint(auth_bp)

@app.route("/dashboard")
def dashboard():
    return "Welcome to the dashboard!"

if __name__ == "__main__":
    app.run(debug=True)
```

# **登录页面模板 login.html**

templates/login.html：

```html
<!DOCTYPE html>
<html>
<head>
    <title>Login</title>
</head>
<body>

<h2>Login</h2>

<form method="POST">
    {{ form.hidden_tag() }}
    <p>{{ form.email.label }} : {{ form.email() }}</p>
    <p>{{ form.password.label }} : {{ form.password() }}</p>
    <p>{{ form.submit() }}</p>
</form>

</body>
</html>
```

# **测试流程**

1. 首先建立一个用户（密码需使用 hash 加密）：

```python
from app import app, db
from models.user import User
from werkzeug.security import generate_password_hash

with app.app_context():
    u = User(
        name="Alice",
        email="alice@example.com",
        password=generate_password_hash("123456")
    )
    db.session.add(u)
    db.session.commit()
```

2. 访问
   `http://127.0.0.1:5000/auth/login`

3. 输入 Email + 密码
   登入成功会跳到 `/dashboard`。

4. 测试登出：
   访问 `/auth/logout`。

# **受保护页面示范**

在任何 route 加：

```python
@login_required
def dashboard():
    return f"Welcome {current_user.name}"
```

未登录就会自动跳转到 `/auth/login`。