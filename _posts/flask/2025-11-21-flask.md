---
layout: post
title:  python flask Flask-Login
date:   2025-11-21 11:24:29 +0800
tags: 
    - python 
    - flask
image: 07.jpg
---

# Flask-Login ä½¿ç”¨æ•™å­¦ï¼ˆå®Œæ•´ç¤ºä¾‹ï¼‰

## å®‰è£…å¥—ä»¶

```bash
pip install flask flask-login
```

---

# Flask-Login çš„æ ¸å¿ƒæ¦‚å¿µ

| ç»„ä»¶ | ä½œç”¨ |
| :--- | :--- |
| `LoginManager` | åˆå§‹åŒ–æ‰©å±•ï¼Œç®¡ç†ç™»å½•é…ç½®å’Œå›è°ƒã€‚ |
| `UserMixin` | ä¸ºç”¨æˆ·æ¨¡å‹æä¾›å¿…éœ€çš„å±æ€§å’Œæ–¹æ³•å®ç°ã€‚ |
| `@login_manager.user_loader` | **æ ¸å¿ƒå›è°ƒ**ï¼Œæ ¹æ®ä¼šè¯ä¸­çš„ ID åŠ è½½ç”¨æˆ·å¯¹è±¡ã€‚ |
| `login_user(user, remember=...)` | åœ¨ç™»å½•æˆåŠŸæ—¶è°ƒç”¨ï¼Œå°†ç”¨æˆ· ID å­˜å…¥ä¼šè¯ã€‚ |
| `logout_user()` | åœ¨ç™»å‡ºæ—¶è°ƒç”¨ï¼Œæ¸…é™¤ä¼šè¯ä¸­çš„ç”¨æˆ· IDã€‚ |
| `@login_required` | è§†å›¾è£…é¥°å™¨ï¼Œå¼ºåˆ¶ç”¨æˆ·å¿…é¡»ç™»å½•æ‰èƒ½è®¿é—®ã€‚ |
| `current_user` | å…¨å±€ä»£ç†å¯¹è±¡ï¼Œä»£è¡¨å½“å‰ç™»å½•çš„ç”¨æˆ·ã€‚ |

---

# åˆ›å»ºä½ çš„ User æ¨¡å‹ï¼ˆæœ€é‡è¦ï¼‰

ä½ å¿…é¡»æä¾›ä¸€ä¸ªç”¨æˆ·ç±»ï¼Œå…¶ä¸­è¦åŒ…å«è‡³å°‘ï¼š

* get_id()
* is_authenticated
* is_active
* is_anonymous

å¦‚æœç»§æ‰¿ `UserMixin` å°±å®Œæˆäº†ï¼

```python
from flask_login import UserMixin

# ç¤ºä¾‹ï¼šç®€å•çš„ç”¨æˆ·èµ„æ–™ï¼ˆç”¨å­—å…¸æ¨¡æ‹Ÿæ•°æ®åº“ï¼‰
USERS = {
    "test@example.com": {"password": "123456"}
}

class User(UserMixin):
    def __init__(self, id):
        self.id = id  # é€šå¸¸ä½¿ç”¨ email æˆ–æ•°æ®åº“ä¸­çš„ id
```

---

# å®Œæ•´ Flask-Login é…ç½®

```python
from flask import Flask, render_template_string, request, redirect, url_for
from flask_login import LoginManager, login_user, logout_user, login_required, current_user

app = Flask(__name__)
app.secret_key = "your_secret_key"

login_manager = LoginManager()
login_manager.init_app(app)
login_manager.login_view = "login"  # æ²¡ç™»å½•è®¿é—®ä¿æŠ¤é¡µé¢ä¼šè·³åˆ° login
```

---

### ğŸ”‘ Flask-Login éœ€è¦ user_loader

å®ƒå¿…é¡»æ ¹æ®ç”¨æˆ· ID è¿˜åŸç”¨æˆ·å¯¹è±¡ï¼š

```python
@login_manager.user_loader
def load_user(user_id):
    if user_id in USERS:
        return User(user_id)
    return None
```

---

# ç™»å½•é¡µé¢ï¼ˆPOST å¤„ç†ç™»å½•ï¼‰

```python
@app.route("/login", methods=["GET", "POST"])
def login():
    if request.method == "POST":
        email = request.form["email"]
        password = request.form["password"]

        # æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
        if email in USERS and USERS[email]["password"] == password:
            user = User(email)
            login_user(user)  # ç™»å½•æˆåŠŸ
            return redirect(url_for("protected"))

        return "âŒ ç™»å½•å¤±è´¥ï¼è´¦å·æˆ–å¯†ç é”™è¯¯"

    return '''
    <form method="POST">
        Email: <input type="text" name="email"><br>
        Password: <input type="password" name="password"><br>
        <button>ç™»å½•</button>
    </form>
    '''
```

---

# å—ä¿æŠ¤é¡µé¢ï¼ˆå¿…é¡»ç™»å½•ï¼‰

```python
@app.route("/protected")
@login_required
def protected():
    return f"æ¬¢è¿ï¼Œ{current_user.id}ï¼è¿™æ˜¯å—ä¿æŠ¤çš„é¡µé¢ã€‚"
```

---

# ç™»å‡ºåŠŸèƒ½

```python
@app.route("/logout")
@login_required
def logout():
    logout_user()
    return "ä½ å·²ç»æˆåŠŸç™»å‡ºï¼"
```

---

# ä¸»é¡µ

```python
@app.route("/")
def index():
    if current_user.is_authenticated:
        return f"ä½ å·²ç™»å½•ï¼š{current_user.id} <br> <a href='/logout'>ç™»å‡º</a>"
    return "ä½ è¿˜æ²¡æœ‰ç™»å½• <a href='/login'>ç™»å½•</a>"
```

---

# å®Œæ•´å¯è¿è¡Œé¡¹ç›®

æŠŠä»¥ä¸‹ä»£ç è´´åˆ° `app.py` ç›´æ¥è¿è¡Œå³å¯ï¼š

```python
from flask import Flask, request, redirect, url_for
from flask_login import (
    LoginManager, UserMixin, login_user, logout_user,
    login_required, current_user
)

app = Flask(__name__)
app.secret_key = "your_secret_key"

USERS = {
    "test@example.com": {"password": "123456"}
}

class User(UserMixin):
    def __init__(self, id):
        self.id = id

login_manager = LoginManager()
login_manager.init_app(app)
login_manager.login_view = "login"

@login_manager.user_loader
def load_user(user_id):
    if user_id in USERS:
        return User(user_id)
    return None

@app.route("/")
def index():
    if current_user.is_authenticated:
        return f"å·²ç™»å½•ï¼š{current_user.id} <br><a href='/logout'>ç™»å‡º</a>"
    return "ä½ è¿˜æœªç™»å½• <a href='/login'>ç™»å½•</a>"

@app.route("/login", methods=["GET", "POST"])
def login():
    if request.method == "POST":
        email = request.form["email"]
        password = request.form["password"]

        if email in USERS and USERS[email]["password"] == password:
            user = User(email)
            login_user(user)
            return redirect(url_for("protected"))
        return "ç™»å½•å¤±è´¥ï¼è´¦å·æˆ–å¯†ç é”™è¯¯"

    return '''
    <form method="POST">
        Email: <input name="email"><br>
        Password: <input type="password" name="password"><br>
        <button>ç™»å½•</button>
    </form>
    '''

@app.route("/protected")
@login_required
def protected():
    return f"æ¬¢è¿è¿›å…¥å—ä¿æŠ¤é¡µé¢ï¼Œ{current_user.id}ï¼"

@app.route("/logout")
@login_required
def logout():
    logout_user()
    return "ä½ å·²ç™»å‡ºï¼"

if __name__ == "__main__":
    app.run(debug=True)
```